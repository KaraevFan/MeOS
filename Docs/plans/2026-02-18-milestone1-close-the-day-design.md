# Milestone 1: "Close the Day" + Stability

**Date:** 2026-02-18
**Status:** Approved
**Source:** Daily rhythm design (`Docs/feedback/20260218_MeOS_Daily_Rhythm.md`) + brainstorm session
**Phase:** Phase 1 of the Daily Rhythm rollout

---

## Context

The Life Map kernel (Ring 1) is built and polished through 3+ rounds of self-testing. External user testing hasn't started. The primary risk is retention: life mapping may land, but without daily utility there's no reason to come back between weekly check-ins.

The daily rhythm design doc reframes the journal from "a feature" to "a byproduct of a daily ritual." The evening "Close the Day" session is the right starting point: it's closest to natural behavior, produces the richest reflection data, and validates whether a daily habit sticks before investing in the morning flow or calendar integration.

**Strategic decision:** Ship "Close the Day" + stability hardening before Wave 1 external testing, so testers experience the daily cadence from day one — not life mapping in isolation.

---

## Scope

### 1. `close_day` Session Type

**New session type:** `close_day` — added to the session type enum and constants.

**Conversational arc:**
- 1 opening question drawn from the day's context (priorities, tensions, yesterday's journal)
- Max 1 follow-up if the user shares something significant
- If quick "fine, nothing major" response: accept warmly, close
- Synthesis into journal artifact
- JournalCard rendered inline

**Emotional frame:** Release, not review. Wind-down, not assessment. Sage never suggests action items in the evening — that's morning territory.

**Prompt design:**
```
You are Sage, conducting a brief evening reflection. This should take 2-3 minutes max.

Your goal: Help the user process their day through the lens of what matters
to them right now. The emotional frame is release — help them close the day
and empty their head, not evaluate their performance.

Context: [Life Map overview, life plan commitments, Sage context, yesterday's
journal if exists]

Behavior:
- Open with ONE specific question drawn from their priorities or recent context
- If they share something significant, ask one follow-up
- If it's a quick "fine, nothing major" response, accept it warmly and close
- Never push for more depth than offered — this is a 2-minute wind-down
- Do NOT suggest action items (that's morning territory)
- Close with warmth: "Thanks for checking in. Sleep well." or similar
- Capture energy/mood signal if naturally expressed (don't ask for a rating)

Do NOT: Generate a formal synthesis. Suggest action items. Reference more
than one priority. Make the user feel like this is a performance review.
Push for more than 2-3 exchanges total.
```

**Write permissions (enforced at tool level, not just prompts):**
- `daily-logs/{date}-journal.md` — the journal artifact
- `sage/context.md` — update Sage's working model

**Cannot write to:** `life-map/*`, `life-plan/*`, `check-ins/*`, `day-plans/*`, `captures/*`

**Context injection reads from:**
1. `life-map/_overview.md` (priorities, north star — for domain tagging)
2. `life-plan/current.md` (active commitments)
3. `sage/context.md` (Sage's working model)
4. Last `daily-logs/*.md` entry (yesterday's journal, for continuity)
5. Last `check-ins/*.md` (most recent check-in)

Does NOT yet read calendar or captures — those are wired when they exist.

### 2. Journal Artifact Output

**Structured output block:**
```
[FILE_UPDATE type="daily-log" name="2026-02-18"]
---
date: 2026-02-18
type: daily-journal
energy: moderate
mood_signal: productive-but-grinding
domains_touched: [career, health]
intention_fulfilled: partial
session_depth: standard
---

## Daily Reflection — Feb 18, 2026

Spent the day deep in the MVP build. Energy was moderate — productive but
grinding. The career transition commitment didn't get attention today; work
expanded again.

Side project deprioritized for the third day this week. Pattern worth
surfacing in next check-in.
[/FILE_UPDATE]
```

**Parser handling:** The parser (`lib/ai/parser.ts`) handles the new `daily-log` type and resolves the file path to `daily-logs/{date}-journal.md`. The `name` attribute in the block provides the date.

**Frontmatter:** Auto-generated by the system (Sage writes markdown body only). Schema defined in Zod.

### 3. JournalCard Component

A new inline card type rendered in chat after the journal conversation concludes. Lighter than domain cards — a "receipt" that says "captured."

**Contents:**
- Date + time
- 1-2 sentence summary
- Energy indicator (subtle dot or word, not a scale)
- Connected domain tags (small pills)
- Subtle footer: "This feeds into your next check-in"

**Visual style:** Compact, warm background, rounded corners. Visually distinct from domain cards and synthesis cards. The feeling: "acknowledged and filed."

### 4. File System Infrastructure

**New directories in user storage:**
- `day-plans/` — for Phase 2 (Open the Day). Created now, empty.
- `daily-logs/` — for journal entries. Used in this milestone.
- `captures/` — for Phase 3 (Quick Capture). Created now, empty.

**Frontmatter schemas (Zod):**

Daily journal frontmatter:
```typescript
{
  date: z.string(), // YYYY-MM-DD
  type: z.literal('daily-journal'),
  energy: z.enum(['high', 'moderate', 'low']).optional(),
  mood_signal: z.string().optional(),
  domains_touched: z.array(z.string()).optional(),
  intention_fulfilled: z.enum(['yes', 'partial', 'no', 'not-applicable']).optional(),
  session_depth: z.enum(['quick-checkin', 'standard', 'deep-processing']).optional(),
  created_at: z.string().optional(),
}
```

Day plan frontmatter (for Phase 2, defined now):
```typescript
{
  date: z.string(),
  type: z.literal('day-plan'),
  intention: z.string().optional(),
  energy_morning: z.enum(['high', 'moderate', 'low']).optional(),
  calendar_events: z.number().optional(),
  key_commitments: z.array(z.string()).optional(),
  created_at: z.string().optional(),
}
```

Capture frontmatter (for Phase 3, defined now):
```typescript
{
  date: z.string(),
  type: z.literal('capture'),
  timestamp: z.string(),
  input_mode: z.enum(['voice', 'text']).optional(),
  classification: z.enum(['thought', 'task', 'idea', 'tension']).optional(),
  auto_tags: z.array(z.string()).optional(),
  folded_into_journal: z.boolean().optional(),
}
```

**Write permissions expanded in constants:**

| Session Type | Can Write To |
|---|---|
| `life_mapping` | `life-map/*`, `life-plan/current.md`, `sage/*` |
| `weekly_checkin` | `check-ins/*`, `life-plan/current.md`, `life-map/*`, `sage/*` |
| `close_day` | `daily-logs/*`, `sage/context.md` |
| `open_day` (Phase 2) | `day-plans/*`, `sage/context.md` |
| `quick_capture` (Phase 3) | `captures/*` |
| `ad_hoc` | `sage/context.md` |

### 5. Home Screen Evening CTA

**Minimal addition to existing home screen.** Not the full card-stack redesign (that's Phase 2).

**Logic:** After ~5pm local time, surface a "Close your day" card above existing content. The card:
- Warm amber background
- "How was today?" heading
- Tapping starts a `close_day` session in chat

**Voice orb:** In the evening, the voice button contextually routes to `close_day` instead of `ad_hoc`.

**Important:** All existing functionality remains accessible. The time-based behavior only affects default action and card ordering — it never removes functionality.

### 6. Weekly Check-In Enhancement

**Lightweight but high-impact.** Check-in context injection now reads from `daily-logs/*` since the last check-in.

**What this enables:**
- Sage references journal data: "Looking at your week, you mentioned feeling stuck on onboarding three times in your evening reflections..."
- Pattern detection seeds: recurring themes across journals surface naturally in check-in conversation
- Intention-vs-reality tracking: if journals show a commitment keeps getting deprioritized, Sage names it

**Prompt addition for check-in:** Include a section in the check-in system prompt that instructs Sage to reference daily journal data when available, treating it as the week's narrative rather than asking "how was your week?" cold.

This is the "capture down, synthesize up" principle in action. Check-ins get dramatically richer for free.

### 7. P0 Reliability Fixes

From the fresh-eyes project audit (`Docs/feedback/20260217_fresh-eyes-project-audit.md`):

1. **Server-side pulse context only** — Remove any client-provided system-prompt append paths in `app/api/chat/route.ts`. Pulse check context must be constructed server-side to close the prompt-injection surface.

2. **Durable file-index updates** — The `updateFileIndex` call is currently fire-and-forget. Await it, add retry/backoff, and log failures. The sidebar and life map views depend on index consistency.

3. **Request validation** — Add Zod schemas for request bodies on core API routes (`chat`, `transcribe`, `push/subscribe`). Reject malformed requests at the boundary.

---

## What Does NOT Ship

- "Open the Day" morning flow (Milestone 2 — needs calendar)
- Quick Capture (Milestone 3)
- Mid-day nudge (Milestone 3)
- Full home screen card-stack redesign (Milestone 2)
- Google Calendar integration (Milestone 2)
- Agent-native tool architecture (evolves toward — FILE_UPDATE system is a stepping stone)
- Home screen content redistribution to Life Map tab (Milestone 2)
- Task/backlog management (later)

---

## Timeline: ~10 Days

| Days | Work |
|---|---|
| 1-2 | File system infra: new directories, session type enum, write permissions, frontmatter Zod schemas, parser `daily-log` type handler |
| 3-5 | `close_day` prompt + context injection + conversation flow + JournalCard component |
| 6-7 | Home screen evening CTA + voice orb routing + check-in context enhancement |
| 8-9 | P0 reliability fixes (server-side pulse context, durable file-index, request validation) |
| 10 | Self-test full evening loop end-to-end, fix issues |

---

## Exit Criteria (Before Wave 1)

- [ ] Complete a `close_day` session via voice; JournalCard appears inline in chat
- [ ] Journal file exists in storage with correct frontmatter and body
- [ ] Weekly check-in references journal data from previous days
- [ ] Home screen shows "Close your day" CTA after 5pm
- [ ] Voice orb routes to `close_day` in the evening
- [ ] Write permission enforcement: `close_day` cannot write to `life-map/` or `life-plan/`
- [ ] `npm run type-check` passes
- [ ] `npm run lint` passes
- [ ] `npx vitest run` passes (all existing + new tests)
- [ ] No regressions on life mapping or check-in flows

---

## Decision Gate (After Wave 1 Testing)

Wave 1: 4-5 external users test life mapping + "Close the Day" daily loop. Same-day interviews.

| Signal | Meaning | Next move |
|---|---|---|
| 4/5 testers complete life mapping AND express "this gets me" | Kernel works | Proceed as planned |
| 3/5 testers use "Close the Day" 3+ times in first week | Evening rhythm sticks | Ship Milestone 2: "Open the Day" + calendar |
| Life mapping lands but evening journal ignored | Daily cadence needs work | Iterate on journal prompt/timing/CTA before Milestone 2 |
| Testers love journal but skip check-ins | Daily > weekly for this audience | Rethink check-in cadence |
| Users bounce off onboarding | Pre-conversation problem | Fix onboarding first, delay everything else |

---

## Roadmap Position

```
Milestone 1: "Close the Day" + Stability          ← THIS MILESTONE
  → Wave 1 testing (4-5 external users)

Milestone 2: "Open the Day" + Calendar + Home Screen Redesign
  → Wave 2 testing (returnees + new users)

Milestone 3: Quick Capture + Mid-Day + Full Daily Rhythm
  → Wave 3 testing (full POS experience)

Milestone 4: Ring 3 — Pattern Detection + Trust Ladder
  → Beta expansion (15-20 users)

Milestone 5: Ring 4 — Agentic Execution
  → Public launch prep
```

Each milestone builds on the previous one. Each has a decision gate. The daily rhythm design doc (`Docs/feedback/20260218_MeOS_Daily_Rhythm.md`) is the architectural north star — this milestone is Phase 1 of that vision.

---

## References

- Daily rhythm design: `Docs/feedback/20260218_MeOS_Daily_Rhythm.md`
- POS strategy: `Docs/plans/2026-02-16-pos-vision-strategy-design.md`
- Fresh-eyes audit: `Docs/feedback/20260217_fresh-eyes-project-audit.md`
- Vision: `Docs/vision.md`
- MVP PRD: `Docs/MVP_PRD.md`
